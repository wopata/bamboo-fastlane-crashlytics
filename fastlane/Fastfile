### Fastlane's configuration
fastlane_version "1.62.0"
default_platform :ios

CRASHLYTICS = {
  api_token: "f177a7b6420cda3a7516673e502392fec8c60040",
  build_secret: "cc5e82acbc97173d884018a4933227d9773f0f213aa2f8d424a0eb6968de32e6",
  notes: "Bundle generated by Bamboo",
  send_mail_notifications: true,
  testers: {
    "Wopata Test" => "wopata.test@gmail.com"
  }
}

### Lanes
platform :ios do

  before_all do
  end

  lane :deploy do
    if testers = ENV["CRASHLYTICS_TESTERS"]
      testers.split(',').each_with_index do |t,i|
        CRASHLYTICS[:testers]["tester_#{i}"] = t
      end
    end
    testers = CRASHLYTICS[:testers].values.uniq
    emails = testers.length == 1 ? testers[0] : "#{testers[0...-1].join(', ')} and #{testers[-1]}"
    UI.success("The build will be shared to ️#{emails} ✉️")
    upload_to_crashlytics
  end

  after_all do |lane|
  end

  error do |lane, exception|
  end

end

def upload_to_crashlytics
  crashlytics(
    api_token: CRASHLYTICS[:api_token],
    build_secret: CRASHLYTICS[:build_secret],
    notes: CRASHLYTICS[:notes],
    emails: CRASHLYTICS[:testers].values.uniq.join(","),
    notifications: CRASHLYTICS[:send_mail_notifications],
    debug: true,
  )
end
